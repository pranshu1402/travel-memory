---
# Ansible Playbook for MongoDB Exporter Installation on Database Server

- name: Install and Configure MongoDB Exporter
  hosts: db_servers
  become: yes
  vars:
    mongodb_exporter_version: "0.42.0"
    mongodb_exporter_user: mongodb_exporter
    mongodb_exporter_group: mongodb_exporter
    mongodb_exporter_dir: /opt/mongodb_exporter
    mongodb_uri: "mongodb://{{ mongo_db_user | default('traveluser') }}:{{ mongo_db_password | default('traveluser') }}@localhost:27017/{{ mongo_db_name | default('travelmemory') }}?authSource={{ mongo_db_name | default('travelmemory') }}"

  pre_tasks:
    - name: Set mongo_db_password with default
      set_fact:
        mongo_db_password: "{{ mongo_db_password | default('traveluser') }}"
      when: mongo_db_password is not defined
    
    - name: Set mongo_db_user with default
      set_fact:
        mongo_db_user: "{{ mongo_db_user | default('traveluser') }}"
      when: mongo_db_user is not defined
    
    - name: Set mongo_db_name with default
      set_fact:
        mongo_db_name: "{{ mongo_db_name | default('travelmemory') }}"
      when: mongo_db_name is not defined

  tasks:
    - name: Create mongodb_exporter user
      user:
        name: "{{ mongodb_exporter_user }}"
        system: yes
        shell: /bin/false
        home: "{{ mongodb_exporter_dir }}"
        create_home: no
        comment: "MongoDB Exporter user"

    - name: Create mongodb_exporter directory
      file:
        path: "{{ mongodb_exporter_dir }}"
        state: directory
        owner: "{{ mongodb_exporter_user }}"
        group: "{{ mongodb_exporter_group }}"
        mode: '0755'

    - name: Download MongoDB Exporter
      get_url:
        url: "https://github.com/percona/mongodb_exporter/releases/download/v{{ mongodb_exporter_version }}/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64.tar.gz"
        dest: /tmp/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64.tar.gz
        mode: '0644'

    - name: Extract MongoDB Exporter
      unarchive:
        src: /tmp/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64.tar.gz
        dest: /tmp
        remote_src: yes

    - name: Copy MongoDB Exporter binary
      copy:
        src: "/tmp/mongodb_exporter-{{ mongodb_exporter_version }}.linux-amd64/mongodb_exporter"
        dest: "{{ mongodb_exporter_dir }}/mongodb_exporter"
        owner: "{{ mongodb_exporter_user }}"
        group: "{{ mongodb_exporter_group }}"
        mode: '0755'
        remote_src: yes

    - name: Create MongoDB Exporter systemd service
      copy:
        content: |
          [Unit]
          Description=MongoDB Exporter
          Documentation=https://github.com/percona/mongodb_exporter
          After=network-online.target mongod.service
          Wants=network-online.target

          [Service]
          Type=simple
          User={{ mongodb_exporter_user }}
          Group={{ mongodb_exporter_group }}
          Environment="MONGODB_URI={{ mongodb_uri }}"
          ExecStart={{ mongodb_exporter_dir }}/mongodb_exporter \
            --web.listen-address=0.0.0.0:9216 \
            --compatible-mode

          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/mongodb_exporter.service
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Start and enable MongoDB Exporter service
      systemd:
        name: mongodb_exporter
        state: started
        enabled: yes

    - name: Wait for MongoDB Exporter to be ready
      uri:
        url: http://localhost:9216/metrics
        method: GET
      register: exporter_ready
      until: exporter_ready.status == 200
      retries: 10
      delay: 5
      ignore_errors: yes

    - name: Check MongoDB Exporter status
      systemd:
        name: mongodb_exporter
      register: exporter_status

    - name: Display MongoDB Exporter status
      debug:
        msg: "MongoDB Exporter is {{ exporter_status.status.ActiveState }} at http://localhost:9216/metrics"

