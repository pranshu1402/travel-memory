---
# Ansible Playbook for MongoDB Database Server Setup

- name: Configure MongoDB Database Server
  hosts: db_servers
  become: yes
  vars:
    mongo_version: "7.0"
    mongo_db_name: travelmemory
    mongo_db_user: traveluser
    mongo_db_password_default: "traveluser"
    web_server_private_ip_default: "172.31.71.243"
  
  pre_tasks:
    - name: Set mongo_db_password with default
      set_fact:
        mongo_db_password: "{{ mongo_db_password | default(mongo_db_password_default) }}"
    
    - name: Set web_server_private_ip with default
      set_fact:
        web_server_private_ip: "{{ web_server_private_ip | default(web_server_private_ip_default) }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - gnupg
          - ufw
        state: present

    # MongoDB Installation
    - name: Import MongoDB GPG key
      apt_key:
        url: https://pgp.mongodb.com/server-{{ mongo_version }}.asc
        state: present

    - name: Add MongoDB repository
      apt_repository:
        repo: "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/{{ mongo_version }} multiverse"
        state: present
        filename: mongodb-org-{{ mongo_version }}

    - name: Install MongoDB
      apt:
        name:
          - mongodb-org
        state: present
        update_cache: yes

    - name: Start and enable MongoDB service
      systemd:
        name: mongod
        state: started
        enabled: yes

    - name: Wait for MongoDB to start
      wait_for:
        port: 27017
        delay: 5
        timeout: 30

    # Configure MongoDB for remote access
    - name: Backup MongoDB config file
      copy:
        src: /etc/mongod.conf
        dest: /etc/mongod.conf.backup
        remote_src: yes
      changed_when: false

    - name: Configure MongoDB to listen on all interfaces
      lineinfile:
        path: /etc/mongod.conf
        regexp: '^  bindIp:'
        line: '  bindIp: 0.0.0.0'
        backup: yes

    - name: Restart MongoDB after config change
      systemd:
        name: mongod
        state: restarted

    - name: Wait for MongoDB to restart
      wait_for:
        port: 27017
        delay: 5
        timeout: 30

    # Create MongoDB database and user
    - name: Create MongoDB database (by accessing it)
      shell: |
        mongosh {{ mongo_db_name }} --eval "db.getName()" --quiet
      register: mongo_db_create
      changed_when: false
      ignore_errors: yes

    - name: Check if MongoDB user exists
      shell: |
        mongosh {{ mongo_db_name }} --eval "
        try {
          db.getUser('{{ mongo_db_user }}');
          quit(0);
        } catch(e) {
          if (e.message.includes('UserNotFound') || e.message.includes('not found')) {
            quit(1);
          } else {
            quit(2);
          }
        }
        " --quiet
      register: mongo_user_check
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Create MongoDB database and user
      shell: |
        mongosh {{ mongo_db_name }} --eval "
        try {
          db.createUser({
            user: '{{ mongo_db_user }}',
            pwd: '{{ mongo_db_password }}',
            roles: [{ role: 'readWrite', db: '{{ mongo_db_name }}' }]
          });
          print('User created successfully');
          quit(0);
        } catch(e) {
          if (e.message.includes('already exists') || e.message.includes('already in use')) {
            print('User already exists');
            quit(0);
          } else {
            print('Error: ' + e.message);
            quit(1);
          }
        }
        " --quiet
      register: mongo_user_create
      changed_when: "'created successfully' in mongo_user_create.stdout"
      when: mongo_user_check.rc != 0
      failed_when: mongo_user_create.rc != 0

    - name: Display MongoDB user creation result
      debug:
        msg: |
          MongoDB user creation result:
          Return code: {{ mongo_user_create.rc | default('N/A') }}
          Stdout: {{ mongo_user_create.stdout | default('N/A') }}
          Stderr: {{ mongo_user_create.stderr | default('N/A') }}
      when: 
        - mongo_user_create is defined
        - mongo_user_create.rc is defined

    - name: Verify MongoDB user creation
      shell: |
        mongosh {{ mongo_db_name }} --authenticationDatabase {{ mongo_db_name }} -u {{ mongo_db_user }} -p {{ mongo_db_password }} --eval "db.getName()" --quiet
      register: mongo_verify
      changed_when: false
      failed_when: false
      ignore_errors: yes

    - name: Display MongoDB verification result
      debug:
        msg: "MongoDB user verification successful: {{ mongo_verify.stdout }}"
      when: mongo_verify.rc == 0

    - name: Display MongoDB verification error if any
      debug:
        msg: |
          MongoDB user verification failed:
          Return code: {{ mongo_verify.rc }}
          Stdout: {{ mongo_verify.stdout }}
          Stderr: {{ mongo_verify.stderr }}
      when: mongo_verify.rc != 0

    - name: Alternative verification without authentication (for initial setup)
      shell: |
        mongosh {{ mongo_db_name }} --eval "
        try {
          var user = db.getUser('{{ mongo_db_user }}');
          if (user) {
            print('User exists: {{ mongo_db_user }}');
            print('Database: {{ mongo_db_name }}');
            quit(0);
          } else {
            quit(1);
          }
        } catch(e) {
          print('Error checking user: ' + e.message);
          quit(1);
        }
        " --quiet
      register: mongo_user_check_alt
      changed_when: false
      failed_when: false
      ignore_errors: yes
      when: mongo_verify.rc != 0

    - name: Display alternative verification result
      debug:
        msg: |
          Alternative verification result:
          Return code: {{ mongo_user_check_alt.rc | default('N/A') }}
          Stdout: {{ mongo_user_check_alt.stdout | default('N/A') }}
          Stderr: {{ mongo_user_check_alt.stderr | default('N/A') }}
      when: mongo_verify.rc != 0 and mongo_user_check_alt is defined

    # UFW Firewall Configuration for MongoDB
    - name: Allow SSH through firewall
      ufw:
        rule: allow
        port: '22'
        proto: tcp
        comment: 'SSH access'

    - name: Allow MongoDB port from web server only
      ufw:
        rule: allow
        port: '27017'
        proto: tcp
        from_ip: "{{ web_server_private_ip }}"
        comment: 'MongoDB access from web server'

    - name: Enable UFW firewall
      ufw:
        state: enabled
        policy: deny

    - name: Display UFW status
      command: ufw status verbose
      register: ufw_status
      changed_when: false

    - name: Show firewall status
      debug:
        msg: "{{ ufw_status.stdout_lines }}"

